<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CON Hall Booking System</title>
    <link rel="icon" href="https://concihsr.in/wp-content/uploads/2024/10/CON-logo-small.png" />
    <style>
        :root {
            --primary: #003366;
            --accent: #0055aa;
            --card: #ffffff;
            --muted: #777;
            --bg: #f4f6f8;
            --success: #28a745;
            --error: #dc3545;
        }
        
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background: var(--bg);
            color: #222;
        }
        
        header {
            background: var(--primary);
            color: white;
            padding: 18px 10px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        header h1 {
            margin: 0;
            font-size: 22px;
            text-align: center;
        }
        
        .container {
            max-width: 1100px;
            margin: 20px auto;
            padding: 10px;
        }
        
        .nav-links {
            text-align: center;
            margin-bottom: 16px;
        }
        
        .nav-links a {
            color: var(--primary);
            margin: 0 8px;
            text-decoration: none;
            padding: 8px 12px;
            background: #fff;
            border-radius: 6px;
            transition: all 0.3s ease;
        }
        
        .nav-links a:hover,
        .nav-links a.active {
            background: var(--primary);
            color: white;
        }
        
        .content {
            display: none;
            background: var(--card);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        }
        
        .content.active {
            display: block;
        }
        
        .form-container {
            max-width: 900px;
            margin: auto;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .form-group {
            margin-bottom: 12px;
        }
        
        label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
        }
        
        input[type="text"],
        input[type="date"],
        input[type="time"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
        }
        
        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 10px 14px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        button:hover {
            background: var(--accent);
        }
        
        button.secondary {
            background: #666;
        }
        
        button.success {
            background: var(--success);
        }
        
        button.error {
            background: var(--error);
        }
        
        .rooms-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 10px;
        }
        
        .room-card {
            background: #fff;
            border: 1px solid #e6e6e6;
            padding: 10px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.03);
            transition: all 0.2s ease;
        }
        
        .room-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        
        .room-card input {
            width: 18px;
            height: 18px;
        }
        
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal .modal-content {
            background: #fff;
            padding: 24px;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .admin-login {
            max-width: 420px;
            margin: auto;
        }
        
        .logo {
            background: #fff;
            display: flex;
            justify-content: center;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 12px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
        }
        
        th,
        td {
            border: 1px solid #eee;
            padding: 10px;
            text-align: left;
        }
        
        th {
            background: var(--primary);
            color: white;
        }
        
        .stats {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        
        .stat-card {
            background: #fff;
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            flex: 1;
            min-width: 120px;
            text-align: center;
        }
        
        .stat-card h3 {
            margin: 0;
            font-size: 24px;
            color: var(--primary);
        }
        
        .stat-card p {
            margin: 4px 0 0;
            color: var(--muted);
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }
        
        .error-message {
            color: var(--error);
            font-size: 14px;
            margin-top: 4px;
            display: none;
        }
        
        .success-message {
            color: var(--success);
            font-size: 14px;
            margin-top: 4px;
            display: none;
        }
        
        .filter-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }
        
        .filter-controls select,
        .filter-controls input {
            flex: 1;
            min-width: 150px;
        }
        
        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-approved {
            background: #d4edda;
            color: #155724;
        }
        
        .status-rejected {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
<header><h1>CON Hall Booking</h1></header>
<div class="container">
    <div class="nav-links">
        <a href="#" class="nav-link active" data-target="booking">Book Room</a>
        <a href="#" class="nav-link" data-target="events">View Events</a>
        <a href="#" class="nav-link" data-target="admin-login">Admin</a>
        <a href="#" class="nav-link" data-target="admin" id="admin-nav" style="display:none;">Dashboard</a>
        <a href="#" class="nav-link" id="logout-btn" style="display:none; background:var(--error); color:white;">Logout</a>
    </div>

    <!-- Booking Section -->
    <div class="content active" id="booking">
        <h2>Book Conference Rooms</h2>
        <div class="form-container">
            <div class="form-group">
                <label>Rooms <span class="error-message" id="roomsError">Select at least one room</span></label>
                <div id="roomsContainer" class="rooms-grid"></div>
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <label>Event Name <span class="error-message" id="eventNameError">Event name is required</span></label>
                    <input type="text" id="eventName" autocomplete="off" autocorrect="off">
                </div>
                <div class="form-group">
                    <label>Department <span class="error-message" id="departmentError">Department is required</span></label>
                    <input type="text" id="department" autocomplete="off" autocorrect="off">
                </div>

                <div class="form-group">
                    <label>Start Date <span class="error-message" id="startDateError">Valid start date is required</span></label>
                    <input type="date" id="startDate" autocomplete="off" min="">
                </div>
                <div class="form-group">
                    <label>End Date <span class="error-message" id="endDateError">Valid end date is required</span></label>
                    <input type="date" id="endDate" autocomplete="off" min="">
                </div>

                <div class="form-group">
                    <label>Start Time <span class="error-message" id="startTimeError">Start time is required</span></label>
                    <input type="time" id="startTime">
                </div>
                <div class="form-group">
                    <label>End Time <span class="error-message" id="endTimeError">Valid end time is required</span></label>
                    <input type="time" id="endTime">
                </div>

                <div class="form-group">
                    <label>Participants <span class="error-message" id="participantsError">Must have at least 1 participant</span></label>
                    <input type="number" id="participants" value="1" min="1">
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="notes"></textarea>
                </div>
            </div>
            <div style="margin-top:12px;">
                <button id="bookingButton">Submit Booking</button>
                <button id="resetButton" class="secondary">Reset Form</button>
                <span class="success-message" id="bookingSuccess">Booking submitted successfully!</span>
            </div>
        </div>
    </div>

    <!-- Events Section -->
    <div class="content" id="events">
        <h2>Scheduled Events</h2>
        <div class="filter-controls">
            <select id="roomFilter">
                <option value="">All Rooms</option>
            </select>
            <input type="date" id="dateFilter">
            <button id="clearFilters">Clear Filters</button>
        </div>
        <div id="eventsList"></div>
    </div>

    <!-- Admin Login Section -->
    <div class="content" id="admin-login">
        <div class="admin-login">
            <div class="logo"><img src="https://concihsr.in/wp-content/uploads/2024/10/CON-logo-small.png" alt="logo" style="height:48px;"></div>
            <h3 style="text-align:center;margin-top:0;">Admin Login</h3>
            <div class="form-container">
                <div class="form-group"><label>Username</label><input type="text" id="adminUsername" autocomplete="off"></div>
                <div class="form-group"><label>Password</label><input type="password" id="adminPassword" autocomplete="off"></div>
                <div style="text-align:center;margin-top:8px;">
                    <button id="adminLoginButton">Login</button>
                    <div class="loading" id="loginLoading" style="display:none;"></div>
                </div>
                <div id="adminLoginError" class="error-message">Invalid login credentials</div>
            </div>
        </div>
    </div>

    <!-- Admin Dashboard Section -->
    <div class="content" id="admin">
        <h2>Admin Dashboard</h2>
        <div class="stats">
            <div class="stat-card">
                <h3 id="pendingCount">0</h3>
                <p>Pending Requests</p>
            </div>
            <div class="stat-card">
                <h3 id="approvedCount">0</h3>
                <p>Approved Bookings</p>
            </div>
            <div class="stat-card">
                <h3 id="totalRooms">0</h3>
                <p>Available Rooms</p>
            </div>
        </div>

        <h3>Add New Room</h3>
        <div class="form-container">
            <div class="form-group">
                <input type="text" id="newRoomName" placeholder="Room name" autocomplete="off">
                <span class="error-message" id="roomNameError">Room name is required</span>
            </div>
            <div>
                <button id="addRoomButton">Add Room</button>
                <span class="success-message" id="roomSuccess">Room added successfully!</span>
            </div>
        </div>

        <h3>Pending Approval</h3>
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>Event</th>
                        <th>Rooms</th>
                        <th>Dates</th>
                        <th>Time</th>
                        <th>Participants</th>
                        <th>Dept</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="pendingRequests"></tbody>
            </table>
        </div>

        <h3>Approved Bookings</h3>
        <div class="filter-controls">
            <input type="date" id="approvedDateFilter">
            <button id="clearApprovedFilter">Clear Filter</button>
        </div>
        <div class="table-responsive">
            <table>
                <thead>
                    <tr>
                        <th>Event</th>
                        <th>Rooms</th>
                        <th>Dates</th>
                        <th>Time</th>
                        <th>Participants</th>
                        <th>Dept</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="approvedBookings"></tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal Dialog -->
<div class="modal" id="messageModal">
    <div class="modal-content">
        <h3 id="modalTitle"></h3>
        <div id="modalContent"></div>
        <div style="text-align:right;margin-top:16px;">
            <button id="modalOkButton">OK</button>
        </div>
    </div>
</div>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
// ===== CONFIGURATION =====
const TODAY = new Date().toISOString().split('T')[0];

// ===== DOM ELEMENT SHORTCUTS =====
function el(q) { return document.querySelector(q); }
function els(q) { return document.querySelectorAll(q); }

// ===== UTILITY FUNCTIONS =====
function showModal(title, content) { 
    el('#modalTitle').textContent = title; 
    el('#modalContent').innerHTML = content; 
    el('#messageModal').style.display = 'flex'; 
}

function hideModal() { 
    el('#messageModal').style.display = 'none'; 
}

function showError(elementId, message) {
    const errorEl = el(`#${elementId}`);
    errorEl.textContent = message;
    errorEl.style.display = 'block';
    setTimeout(() => errorEl.style.display = 'none', 5000);
}

function showSuccess(elementId, message) {
    const successEl = el(`#${elementId}`);
    successEl.textContent = message;
    successEl.style.display = 'block';
    setTimeout(() => successEl.style.display = 'none', 5000);
}

function clearValidation() {
    els('.error-message').forEach(el => el.style.display = 'none');
    els('.success-message').forEach(el => el.style.display = 'none');
}

// ===== FORM HANDLING =====
function resetBookingForm() {
    els('input, textarea').forEach(inp => {
        if (inp.type === 'checkbox') inp.checked = false;
        else if (inp.type !== 'button' && inp.type !== 'submit') inp.value = '';
    });
    
    // Reset date min values
    el('#startDate').min = TODAY;
    el('#endDate').min = TODAY;
    
    // Reset cleared flags
    els('input[type="text"], textarea').forEach(i => i.dataset._cleared = 'false');
    
    // Reload rooms
    loadRooms();
    
    clearValidation();
}

// Clear on first focus to avoid previous autofill values showing
els('input[type="text"], textarea').forEach(inp => {
    inp.dataset._cleared = "false";
    inp.addEventListener('focus', function() { 
        if (this.dataset._cleared === "false") { 
            this.value = ''; 
            this.dataset._cleared = "true"; 
        } 
    });
});

// ===== ROOM MANAGEMENT =====
function loadRooms() {
    const startDate = el('#startDate').value;
    const endDate = el('#endDate').value;
    const startTime = el('#startTime').value;
    const endTime = el('#endTime').value;
    
    let url = '/rooms';
    if (startDate && endDate && startTime && endTime) {
        url += `?startDate=${startDate}&endDate=${endDate}&startTime=${startTime}&endTime=${endTime}`;
    }
    
    // Show loading state
    const container = el('#roomsContainer');
    container.innerHTML = '<div style="text-align:center;padding:20px;">Loading rooms...</div>';
    
    fetch(url)
    .then(r => r.json())
    .then(rooms => {
        container.innerHTML = '';
        
        // Also update room filter
        const roomFilter = el('#roomFilter');
        roomFilter.innerHTML = '<option value="">All Rooms</option>';
        
        rooms.forEach(rm => {
            // Add to rooms container
            const div = document.createElement('div');
            div.className = 'room-card';
            div.innerHTML = `
                <input type="checkbox" class="room-checkbox" value="${rm.id}" id="room_${rm.id}" 
                    ${rm.available === false ? 'disabled' : ''}>
                <label for="room_${rm.id}" data-name="${rm.name}">${rm.name} ${rm.available === false ? '(Unavailable)' : ''}</label>
            `;
            container.appendChild(div);
            
            // Add to room filter
            const option = document.createElement('option');
            option.value = rm.id;
            option.textContent = rm.name;
            roomFilter.appendChild(option);
        });
        
        // Update total rooms count in admin dashboard
        if (el('#totalRooms')) {
            el('#totalRooms').textContent = rooms.length;
        }
    })
    .catch(err => {
        console.error('Error loading rooms:', err);
        container.innerHTML = '<div style="text-align:center;color:var(--error);padding:20px;">Failed to load rooms. Please try again.</div>';
    });
}

// ===== FORM VALIDATION =====
function validateForm() {
    clearValidation();
    let isValid = true;
    
    // Check if at least one room is selected
    const selectedRooms = els('.room-checkbox:checked');
    if (selectedRooms.length === 0) {
        showError('roomsError', 'Select at least one room');
        isValid = false;
    }
    
    // Validate event name
    const eventName = el('#eventName').value.trim();
    if (!eventName) {
        showError('eventNameError', 'Event name is required');
        isValid = false;
    }
    
    // Validate department
    const department = el('#department').value.trim();
    if (!department) {
        showError('departmentError', 'Department is required');
        isValid = false;
    }
    
    // Validate dates
    const startDate = el('#startDate').value;
    const endDate = el('#endDate').value;
    if (!startDate) {
        showError('startDateError', 'Start date is required');
        isValid = false;
    }
    if (!endDate) {
        showError('endDateError', 'End date is required');
        isValid = false;
    }
    
    if (startDate && endDate) {
        const start = new Date(startDate);
        const end = new Date(endDate);
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        if (start < today) {
            showError('startDateError', 'Start date cannot be in the past');
            isValid = false;
        }
        if (end < start) {
            showError('endDateError', 'End date cannot be before start date');
            isValid = false;
        }
        
        // Add maximum date limit (e.g., 1 year from now)
        const maxDate = new Date();
        maxDate.setFullYear(maxDate.getFullYear() + 1);
        if (start > maxDate || end > maxDate) {
            showError('startDateError', 'Booking cannot be more than 1 year in advance');
            isValid = false;
        }
    }
    
    // Validate times
    const startTime = el('#startTime').value;
    const endTime = el('#endTime').value;
    if (!startTime) {
        showError('startTimeError', 'Start time is required');
        isValid = false;
    }
    if (!endTime) {
        showError('endTimeError', 'End time is required');
        isValid = false;
    }
    
    if (startTime && endTime && startDate === endDate && endTime <= startTime) {
        showError('endTimeError', 'End time must be after start time');
        isValid = false;
    }
    
    // Validate participants
    const participants = parseInt(el('#participants').value);
    if (isNaN(participants) || participants < 1) {
        showError('participantsError', 'Must have at least 1 participant');
        isValid = false;
    }
    
    return isValid;
}

// ===== BOOKING SUBMISSION =====
function submitBooking() {
    if (!validateForm()) return;
    
    const selectedBoxes = Array.from(els('.room-checkbox:checked'));
    const selected = selectedBoxes.map(cb => cb.value);
    const selectedNames = selectedBoxes.map(cb => cb.nextElementSibling.dataset.name);
    
    const data = {
        rooms: selected,
        eventName: el('#eventName').value.trim(),
        startDate: el('#startDate').value,
        endDate: el('#endDate').value,
        startTime: el('#startTime').value,
        endTime: el('#endTime').value,
        participants: parseInt(el('#participants').value),
        department: el('#department').value.trim(),
        notes: el('#notes').value.trim()
    };
    
    // Show loading state
    const originalText = el('#bookingButton').textContent;
    el('#bookingButton').innerHTML = '<span class="loading"></span> Processing...';
    el('#bookingButton').disabled = true;
    
    fetch('/book', {
        method: 'POST', 
        headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        }, 
        body: JSON.stringify(data)
    })
    .then(response => {
        const contentType = response.headers.get('content-type');
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        if (contentType && contentType.includes('application/json')) {
            return response.json();
        } else {
            return response.text().then(text => {
                try {
                    return JSON.parse(text);
                } catch (e) {
                    throw new Error(`Server returned non-JSON: ${text.substring(0, 100)}`);
                }
            });
        }
    })
    .then(res => {
        // Reset button state
        el('#bookingButton').textContent = originalText;
        el('#bookingButton').disabled = false;
        
        if (res.success) {
            const bk = res.booking || data;
            const details = `
                <p><strong>Event:</strong> ${bk.eventName}</p>
                <p><strong>Rooms:</strong> ${selectedNames.join(', ')}</p>
                <p><strong>Dates:</strong> ${bk.startDate} to ${bk.endDate}</p>
                <p><strong>Time:</strong> ${bk.startTime} - ${bk.endTime}</p>
                <p><strong>Participants:</strong> ${bk.participants}</p>
                <p><strong>Department:</strong> ${bk.department}</p>
                <p><strong>Notes:</strong> ${bk.notes || 'None'}</p>
                <hr><p>Status: <span class="status-badge status-pending">Pending admin approval</span></p>
            `;
            showModal('Booking Confirmation', details);
            
            // Clear form
            resetBookingForm();
            
            showSuccess('bookingSuccess', 'Booking submitted successfully!');
        } else {
            showModal('Error', res.error || 'Failed to submit booking');
        }
    })
    .catch(err => {
        // Reset button state
        el('#bookingButton').textContent = originalText;
        el('#bookingButton').disabled = false;
        showModal('Error', 'Server error: ' + err.message);
    });
}

// ===== EVENT RENDERING =====
function renderPendingBookings() {
    fetch('/pending')
    .then(r => r.json())
    .then(events => {
        const container = el('#pendingRequests'); 
        container.innerHTML = '';
        el('#pendingCount').textContent = events.length;
        
        if (events.length === 0) {
            container.innerHTML = '<tr><td colspan="7" style="text-align:center;">No pending requests</td></tr>';
            return;
        }
        
        events.forEach(ev => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${ev.eventName}</td>
                <td>${ev.rooms.join(', ')}</td>
                <td>${ev.startDate} to ${ev.endDate}</td>
                <td>${ev.startTime} - ${ev.endTime}</td>
                <td>${ev.participants}</td>
                <td>${ev.department}</td>
                <td>
                    <button class="btn-accept success" data-id="${ev.id}">Accept</button>
                    <button class="btn-reject error" data-id="${ev.id}">Reject</button>
                </td>
            `;
            container.appendChild(tr);
        });
    })
    .catch(err => console.error('Error loading pending bookings:', err));
}

function renderApprovedBookings() {
    const dateFilter = el('#approvedDateFilter').value;
    let url = '/approved';
    if (dateFilter) {
        url += `?date=${dateFilter}`;
    }
    
    fetch(url)
    .then(r => r.json())
    .then(events => {
        const container = el('#approvedBookings'); 
        container.innerHTML = '';
        el('#approvedCount').textContent = events.length;
        
        if (events.length === 0) {
            container.innerHTML = '<tr><td colspan="7" style="text-align:center;">No approved bookings</td></tr>';
            return;
        }
        
        events.forEach(ev => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${ev.eventName}</td>
                <td>${ev.rooms.join(', ')}</td>
                <td>${ev.startDate} to ${ev.endDate}</td>
                <td>${ev.startTime} - ${ev.endTime}</td>
                <td>${ev.participants}</td>
                <td>${ev.department}</td>
                <td><button class="btn-delete error" data-id="${ev.id}">Delete</button></td>
            `;
            container.appendChild(tr);
        });
    })
    .catch(err => console.error('Error loading approved bookings:', err));
}

function renderPublicEvents() {
    const roomFilter = el('#roomFilter').value;
    const dateFilter = el('#dateFilter').value;
    
    let url = '/approved';
    const params = new URLSearchParams();
    if (roomFilter) params.append('room', roomFilter);
    if (dateFilter) params.append('date', dateFilter);
    
    if (params.toString()) {
        url += '?' + params.toString();
    }
    
    fetch(url)
    .then(r => r.json())
    .then(events => {
        const container = el('#eventsList'); 
        container.innerHTML = '';
        
        if (events.length === 0) {
            container.innerHTML = '<p>No events found for the selected filters.</p>';
            return;
        }
        
        const table = document.createElement('table');
        table.innerHTML = `
            <thead>
                <tr>
                    <th>Event</th>
                    <th>Rooms</th>
                    <th>Dates</th>
                    <th>Time</th>
                    <th>Participants</th>
                    <th>Dept</th>
                </tr>
            </thead>
        `;
        const tbody = document.createElement('tbody');
        
        events.forEach(ev => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${ev.eventName}</td>
                <td>${ev.rooms.join(', ')}</td>
                <td>${ev.startDate} to ${ev.endDate}</td>
                <td>${ev.startTime} - ${ev.endTime}</td>
                <td>${ev.participants}</td>
                <td>${ev.department}</td>
            `;
            tbody.appendChild(tr);
        });
        
        table.appendChild(tbody);
        container.appendChild(table);
    })
    .catch(err => console.error('Error loading public events:', err));
}

// ===== ADMIN ACTIONS =====
function handleAdminAction(e, action, endpoint) {
    const button = e.target;
    const originalText = button.textContent;
    button.innerHTML = '<span class="loading"></span>';
    button.disabled = true;
    
    fetch(endpoint, {
        method: 'POST', 
        headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        }, 
        body: JSON.stringify({id: e.target.dataset.id})
    })
    .then(response => {
        const contentType = response.headers.get('content-type');
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        if (contentType && contentType.includes('application/json')) {
            return response.json();
        } else {
            return response.text().then(text => {
                try {
                    return JSON.parse(text);
                } catch (e) {
                    throw new Error(`Server returned non-JSON: ${text.substring(0, 100)}`);
                }
            });
        }
    })
    .then(() => {
        button.textContent = originalText;
        button.disabled = false;
        
        if (action === 'approve') {
            renderPendingBookings(); 
            renderApprovedBookings(); 
            renderPublicEvents();
        } else if (action === 'reject') {
            renderPendingBookings();
        } else if (action === 'delete') {
            renderApprovedBookings(); 
            renderPublicEvents();
        }
    })
    .catch(err => {
        button.textContent = originalText;
        button.disabled = false;
        console.error(`Error with ${action} action:`, err);
        alert('Error: ' + err.message);
    });
}

// ===== ADD NEW ROOM =====
function addNewRoom() {
    const name = el('#newRoomName').value.trim();
    if (!name) {
        showError('roomNameError', 'Room name is required');
        return;
    }
    
    const button = el('#addRoomButton');
    const originalText = button.textContent;
    button.innerHTML = '<span class="loading"></span> Adding...';
    button.disabled = true;
    
    fetch('/rooms/add', {
        method: 'POST', 
        headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        }, 
        body: JSON.stringify({name: name})
    })
    .then(response => {
        const contentType = response.headers.get('content-type');
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        if (contentType && contentType.includes('application/json')) {
            return response.json();
        } else {
            return response.text().then(text => {
                try {
                    return JSON.parse(text);
                } catch (e) {
                    throw new Error(`Server returned non-JSON: ${text.substring(0, 100)}`);
                }
            });
        }
    })
    .then(res => {
        button.textContent = originalText;
        button.disabled = false;
        
        if (res.success) {
            showSuccess('roomSuccess', res.message);
            el('#newRoomName').value = '';
            loadRooms();
            
            // Add to room filter dropdown
            const roomFilter = el('#roomFilter');
            const option = document.createElement('option');
            option.value = res.room_id || 'new';
            option.textContent = name;
            roomFilter.appendChild(option);
        } else {
            showError('roomNameError', res.error || 'Failed to add room');
        }
    })
    .catch(err => {
        button.textContent = originalText;
        button.disabled = false;
        showError('roomNameError', 'Server error: ' + err.message);
    });
}

// ===== ADMIN LOGIN =====
function adminLogin() {
    const username = el('#adminUsername').value;
    const password = el('#adminPassword').value;
    
    if (!username || !password) {
        showError('adminLoginError', 'Please enter both username and password');
        return;
    }
    
    const button = el('#adminLoginButton');
    const originalText = button.textContent;
    button.innerHTML = '<span class="loading"></span>';
    button.disabled = true;
    el('#adminLoginError').style.display = 'none';
    
    // Use the proper admin login endpoint
    fetch('/admin/login', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        },
        body: JSON.stringify({username, password})
    })
    .then(response => {
        const contentType = response.headers.get('content-type');
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        if (contentType && contentType.includes('application/json')) {
            return response.json();
        } else {
            return response.text().then(text => {
                try {
                    return JSON.parse(text);
                } catch (e) {
                    throw new Error(`Server returned non-JSON: ${text.substring(0, 100)}`);
                }
            });
        }
    })
    .then(res => {
        button.textContent = originalText;
        button.disabled = false;
        
        if (res.success) {
            el('#admin').classList.add('active');
            el('#admin-nav').style.display = 'inline';
            el('#logout-btn').style.display = 'inline';
            el('#admin-login').classList.remove('active');
            
            // Load admin data
            renderPendingBookings();
            renderApprovedBookings();
            loadRooms();
        } else {
            showError('adminLoginError', res.error || 'Invalid credentials');
        }
    })
    .catch(err => {
        button.textContent = originalText;
        button.disabled = false;
        showError('adminLoginError', 'Login error: ' + err.message);
    });
}

// ===== NAVIGATION =====
function showSection(sectionId) {
    // Hide all sections
    els('.content').forEach(s => s.classList.remove('active'));
    // Show selected section
    el(`#${sectionId}`).classList.add('active');
    
    // Update navigation links
    els('.nav-link').forEach(link => link.classList.remove('active'));
    els(`.nav-link[data-target="${sectionId}"]`).forEach(link => link.classList.add('active'));
    
    // Load data for the section
    if (sectionId === 'events') {
        renderPublicEvents();
    } else if (sectionId === 'admin') {
        renderPendingBookings();
        renderApprovedBookings();
    }
}

// ===== EVENT LISTENERS =====
document.addEventListener('DOMContentLoaded', function() {
    // Set min dates
    el('#startDate').min = TODAY;
    el('#endDate').min = TODAY;
    
    // Load initial data
    loadRooms();
    renderPublicEvents();
    
    // Navigation
    els('.nav-link').forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const target = this.dataset.target;
            if (target === 'admin' && !el('#admin-nav').style.display) {
                showSection('admin-login');
            } else {
                showSection(target);
            }
        });
    });
    
    // Form events
    el('#bookingButton').addEventListener('click', submitBooking);
    el('#resetButton').addEventListener('click', resetBookingForm);
    
    // Date/time changes should reload rooms
    ['#startDate', '#endDate', '#startTime', '#endTime'].forEach(sel => {
        el(sel).addEventListener('change', loadRooms);
    });
    
    // Modal
    el('#modalOkButton').addEventListener('click', hideModal);
    el('#messageModal').addEventListener('click', function(e) {
        if (e.target === this) hideModal();
    });
    
    // Admin events
    el('#adminLoginButton').addEventListener('click', adminLogin);
    el('#addRoomButton').addEventListener('click', addNewRoom);
    
    // Event filtering
    el('#roomFilter').addEventListener('change', renderPublicEvents);
    el('#dateFilter').addEventListener('change', renderPublicEvents);
    el('#clearFilters').addEventListener('click', function() {
        el('#roomFilter').value = '';
        el('#dateFilter').value = '';
        renderPublicEvents();
    });
    
    // Admin filtering
    el('#approvedDateFilter').addEventListener('change', renderApprovedBookings);
    el('#clearApprovedFilter').addEventListener('click', function() {
        el('#approvedDateFilter').value = '';
        renderApprovedBookings();
    });
    
    // Logout
    el('#logout-btn').addEventListener('click', function(e) {
        e.preventDefault();
        if (confirm('Are you sure you want to logout?')) {
            // Clear admin session
            fetch('/admin/logout', {method: 'POST'});
            
            // Reset UI
            el('#admin-nav').style.display = 'none';
            el('#logout-btn').style.display = 'none';
            showSection('booking');
        }
    });
    
    // Admin action delegation
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('btn-accept')) {
            handleAdminAction(e, 'approve', '/admin/approve');
        } else if (e.target.classList.contains('btn-reject')) {
            handleAdminAction(e, 'reject', '/admin/reject');
        } else if (e.target.classList.contains('btn-delete')) {
            if (confirm('Delete this booking permanently?')) {
                handleAdminAction(e, 'delete', '/admin/delete');
            }
        }
    });
    
    // Enter key for admin login
    el('#adminPassword').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') adminLogin();
    });
});

// ===== SOCKET.IO FOR REAL-TIME UPDATES =====
const socket = io();
socket.on('bookingUpdate', function(data) {
    // Reload relevant sections when bookings are updated
    if (el('#events').classList.contains('active')) {
        renderPublicEvents();
    }
    if (el('#admin').classList.contains('active')) {
        renderPendingBookings();
        renderApprovedBookings();
    }
});
</script>
</body>
</html>